# sdlog2 

 `sdlog2` 这个应用程序是用来将FMU的飞行数据记录到SD卡中作为日志文件。该日志文件的格式与APM的二进制日志格式兼容，但是''sdlog2'' 使用强制消息''TIME'' 来写时间戳。

## 使用

每当 `sdlog2` 开始记录时， 会在 SD卡的 `log` 文件夹中创建一个新的目录。 如果设置了选项`-t` 同时有一个GPS的时间戳可用的话，文件夹的命名是基于当前的日期的(例如， `log/2014-01-19`)。否则，文件夹就会被命名为 ''sessXXX''，这里`XXX`代表一个序列号。如果可能并且可以使用`t`选项的话，文件名的创建与使用当前时间命名的方式相似(例如，`log/2014-01-19/19_37_52.bin`) 否则这个文件就命名为 `log.XXX.bin` ，再次使用序列号。


根据给定的选项开始记录日志，要么当 `sdlog2` 应用程序启动，要么当系统解锁，或者通过mavlink命令。

    usage: sdlog2 {start|stop|status} [-r <log rate>] [-b <buffer size>] -e -a
            -r      Log rate in Hz, 0 means unlimited rate
            -b      Log buffer size in KBytes, default is 8
            -e      Enable logging on app start (if not, can be started by command)
            -a      Log only when armed (can be still overriden by command)
            -t      Use GPS timestamps to create folder and file names


>The logging performance depends on the speed of the used microSD card. Use a high-quality card to avoid skipped data. Running ''sdlog2'' at full rate (i.e. without ''-r'' option) can cause significant CPU load, without influencing the flight performance negatively though. However, the desired full rate might not be met and the logger will start to skip messages.该日志记录的性能取决于所使用的microSD卡。建议使用高质量的SD卡以避免遗漏数据。全速运行"sdlog2"应用程序（即不加`-l`选项）可能会导致极大的CPU负载，在不影响飞行性能的情况下。然而，所需的全速可能无法得到满足，记录记录将会跳过一些消息。


# Logging Start 

Under normal circumstances logging starts with arming the vehicle, as only active flight are interesting for analysis. To launch logging manually, type these commands on the console:

```
sdlog2 stop

sdlog2 start -t -r 200 -e -b 16
```


Stop logging again by issuing:

```
sdlog2 stop
```



#  Analyzing Logs 

## FlightPlot 

To view and analyze logs, the GUI tool [FlightPlot](https://pixhawk.org/dev/flightplot) can be used. It can read the binary log files generated by `sdlog2` without converting.

## Pymavlink

You can also use the mavgraph tool contained in [PyMAVLink](https://pixhawk.org/dev/pymavlink) to generate plots.

## CSV / Matlab: Converting Logs to CSV 

To read the binary file and convert it to CSV, the python tool [sdlog2_dump.py](https://github.com/PX4/Firmware/tree/master/Tools/sdlog2) can be used. The same directory contains a Matlab script which runs the converter and plots a number of core messages.

E.g. to read `TIME` and `IMU` messages, `BaroAlt` and `BaroTemp` fields from `SENS` message use the following command:

    python sdlog2_dump.py log001.px4log -t TIME -m TIME -m IMU -m SENS.BaroAlt,BaroTemp

To create CSV just redirect output to file:

    python sdlog2_dump.py log001.px4log -t TIME -m TIME -m IMU -m SENS.BaroAlt,BaroTemp > log.csv

Columns in CSV file will have the same order as arguments.Option `-t` significantly reduces duplicate data on output, and should be used always for logs generated by `sdlog2`. But don't use it for original APM logs.

### Example Message Types 

* TIME - Time stamp


* ATT - Vehicle attitude


* ATSP - Vehicle attitude setpoint
* IMU - IMU sensors
* SENS - Other sensors
* LPOS - Local position estimate
* LPSP - Local position setpoint
* GPS - GPS position
* ATTC - Attitude controls (actuator_0 output)
* STAT - Vehicle state
* RC - RC input channels
* OUT0 - Actuator_0 output
* AIRS - Airspeed
* ARSP - Attitude rate setpoint
* FLOW - Optical flow
* GPOS - Global position estimate
* GPSP - Global position setpoint
* ESC - ESC state
* GVSP - Global velocity setpoint



> Message types can be changed sometimes. To find out actual list of messages contained in log file use the following command:
>
>     python sdlog2_dump.py log001.bin -v
>
> Or use [[:dev/flightplot]] to see it.
>

## Troubleshooting

`sdlog2` has a buffer between listening messages and writing log to SD card to avoid suspending critical applications in flight during heavy IO operations. If the buffer is overflowed at some point, some log messages will be skipped. Count of the skipped messages can be checked via console with `sdlog2 status` command. Also statistics printed on closing log file, i.e. on disarm when `-a` option used. If skipped messages count is not zero, it can be fixed with increasing buffer size with  `-b` option. The following command will set log buffer size to 16KiB instead of default 8KiB:



```
sdlog2 start -t -r 100 -e -b 16
```



##  Load testing 

To test the microSD bandwidth, start the app with 200 Hz rate and 32 KB buffer, and the -e flag to log immediately.

```
# First stop the already running instance
sdlog2 stop
sdlog2 start -t -r 200 -e -b 32
# Run the perf command to see the induced sdlog2 load:
# (NOTE: the performance counter only exists during logging)
perf
# Or run top
top
# Stop the app to clean up FDs and filesystem
sdlog2 stop

```



##  Sample Logs 

* `downloads` [sdlog2_sample_log_001.bin.zip](http://7xvob5.com1.z0.glb.clouddn.com/sdlog2_sample_log_001.bin.zip)- captured at 100 Hz rate